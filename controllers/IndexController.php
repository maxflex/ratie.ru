<?php	// Контроллер	class IndexController extends Controller	{		public $defaultAction = "Index";				// Папка вьюх		protected $_viewsFolder	= "index";						public function actionIndex()		{			// Если входим			if (count($_POST)) {				// Находим пользователя				$User = User::find(array(					"condition" => "login='{$_POST['login']}' AND password='{$_POST['password']}'",				));									if ($User) {										// Входим в сессию					$User->toSession(true, true);										$this->redirect($User->login);				} else {										echo "<center><h3 style='width: 46%' class='trans center-content text-white badge-important'>					<span class='glyphicon glyphicon-remove'></span>					Не удалось войти</h3></center>";				}			}						$this->render("index");		}				public function actionLogout()		{			// Удаляем сессию			session_destroy();			session_unset();						// Очищаем куку залогиненного пользователя			removeCookie("ratie_token");						// Очищаем куку сессии PHP			removeCookie("PHPSESSID", "/"); 			//setcookie("PHPSESSID","",time()-3600,"/"); // delete session cookie						if (isset($_COOKIE["PHPSESSID"])) {				exit("HIA");			}						// Редирект на страницу LOGOUT с хэшем, чтобы в ангуляре убралось тоже			$this->redirect("/#logout");		}				// Тут я буду тестить		public function actionAuth()		{			// Подключаем сторонний JS			$this->addJs("//vk.com/js/api/openapi.js", true);						// Подключаем внутренний JS			$this->addJs("auth");						$this->render("auth");		}						// Создаем нового пользователя		public function actionAjaxLoginOrRegister()		{			// Получаем данные пользователя			$user_data = $_POST;						// Если получили			if (!empty($user_data)) {				// Проверяем существует ли пользователь с таким ID вконтакте				$User = User::find(array(					"condition"	=> "id_vk = ".$user_data["uid"],				));								// Если пользователь не существует, то создаем нового				if (!$User) {					// Создаем нового пользователя					$User = new User(array(						"login"			=> $user_data["domain"],						"first_name"	=> $user_data["first_name"],						"last_name"		=> $user_data["last_name"],						"avatar"		=> $user_data["photo_max"],						"id_vk"			=> $user_data["uid"],						"gender"		=> ($user_data["sex"] == 2 ? "0" : "1"),						"social"		=> array(							"vk"		=> $user_data["domain"],							"instagram"	=> $user_data["instagram"],							"twitter"	=> $user_data["twitter"],						),					));										// Устанавливаем значения по умолчанию					$User->setDefaults();										// Сохраняем пользователя					$User->save();										// Если логин уже занят, изменяем /* DELETED:: { (сразу в условии) и сохраняем еще раз					// Предыдущее сохранение обязательно, так как для изменения логина нужен $this->id } */					$User->loginCheck();										// Создаем таблицу пользователя					$User->createTable();										// Уведомляем друзей о регистрации					$User->notifyVkFriends($user_data["friends_ids"]);				}								// Логинимся (true -- Обновляем TOKEN для автовхода, true -- стартуем сессию)				$User->toSession(true, true);								// Возвращаем логин пользователя для редиректа				echo json_encode(array(					"login"	=> $User->login,				));			}		}			}